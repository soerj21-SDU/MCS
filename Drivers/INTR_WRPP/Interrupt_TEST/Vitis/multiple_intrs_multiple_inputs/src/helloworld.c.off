#include <stdio.h>
#include "platform.h"
#include "xparameters.h"
#include "xgpiops.h"
#include "xscugic.h"
#include "xil_exception.h"
#include "xplatform_info.h"
#include <xil_printf.h>
#include "xinterrupt_wrap.h"
#include "xgpio.h"
#include "sleep.h"
#include "XGpioPs.h"

#define GPIO_INTERRUPT_ID XPAR_AXI_GPIO_0_INTERRUPTS
#define GPIO_INTERRUPT_MASK 0x1

XGpio buttons, LEDs, BTN0;

int status; 
// XGpio_Config *ConfigPtr;
XGpioPs_Config *ConfigPtr;


int read_shit;

void myInterupt()
{
    XGpio_InterruptClear(&buttons, GPIO_INTERRUPT_MASK);
    XGpio_DiscreteWrite(&LEDs, 1, 0x00);
    print("In interrupt\n\r");
    sleep(2);
}

void BTN0_INTR()
{
    XGpio_InterruptClear(&BTN0, GPIO_INTERRUPT_MASK);
    XGpio_DiscreteWrite(&LEDs, 1, 0b1000);
    print("In interrupt BTN_0\n\r");
    sleep(2);
}

int main()
{
    init_platform();
    print("Starting program\n\r");

    ConfigPtr = XGpio_LookupConfig(XPAR_AXI_GPIO_0_BASEADDR);
    print("Debug 1\n\r");

    ConfigPtr = XGpio_LookupConfig(0x41800000);
    print("Debug 2\n\r");

    status = XSetupInterruptSystem(&buttons, myInterupt, GPIO_INTERRUPT_ID, XPAR_SCUGIC_SINGLE_DEVICE_ID, XINTERRUPT_DEFAULT_PRIORITY);
    print("Debug 3\n\r");
    if(status != XST_SUCCESS) 
    {
        print("Debug 4\n\r");
        return XST_FAILURE;

    }
    print("Debug 5\n\r");
    status = XSetupInterruptSystem(&BTN0, BTN0_INTR, GPIO_INTERRUPT_ID, XPAR_SCUGIC_SINGLE_DEVICE_ID, XINTERRUPT_DEFAULT_PRIORITY);
    print("Debug 6\n\r");
    if(status != XST_SUCCESS) 
    {
        return XST_FAILURE;
    }
    print("Debug 7\n\r");
    status = XGpio_Initialize(&LEDs, XPAR_XGPIO_1_BASEADDR);
    if(status != XST_SUCCESS) 
    {
        return XST_FAILURE;
    }
    print("Debug 8\n\r");
    status = XGpio_Initialize(&buttons, XPAR_XGPIO_0_BASEADDR);
    if(status != XST_SUCCESS) 
    {
        return XST_FAILURE;
    }
    print("Debug 9\n\r");
    XGpio_SetDataDirection(&LEDs, 1, 0x00);
    print("Debug 10\n\r");
    // XGpio_SetDataDirection(&buttons, 1, 0xFF);
    print("Debug 11\n\r");
    XGpio_SetDataDirection(&BTN0, 1, 0xFF);
    print("Debug 12\n\r");
    // XGpio_InterruptEnable(&buttons, GPIO_INTERRUPT_MASK);
    XGpio_InterruptEnable(&BTN0, GPIO_INTERRUPT_MASK);
    
    print("Debug 13\n\r");
    XGpio_InterruptGlobalEnable(&BTN0);
    // XGpio_InterruptGlobalEnable(&buttons);
    // XEnableIntrId(ConfigPtr->IntrId, ConfigPtr->IntrParent); // Virker ikke

    // XGpioPs_IntrEnable(&buttons, GPIO_INTERRUPT_MASK); // Med PS i navn Virker ikke lige nu mangler bank og mask
    // XGpio_InterruptGlobalEnable(&buttons); 

    // XGpioPs_IntrEnablePin(&buttons, 0); // Virker ikke  
    print("Debug 14\n\r");
    while(1){
        XGpio_DiscreteWrite(&LEDs, 1, 0b0101);
        sleep(1);
        XGpio_DiscreteWrite(&LEDs, 1, 0b1010);
        sleep(1);
        print("In While\n\r");
    }

    cleanup_platform();
    return 0;
}
