#include "includes/CAN_old.h"

int CAN_init(u16 ID) 
{
	int status = XST_SUCCESS;

	// Find hardware configuration from Vivado's generated file xparameters.h
	CAN_CFG[ID] = XCanPs_LookupConfig(ID);
	if (CAN_CFG[ID] == NULL) {
		return XST_FAILURE;
	}

	// Initialize hardware configuration
	XCanPs_CfgInitialize(&CAN_PS[ID], CAN_CFG[ID], CAN_CFG[ID]->BaseAddr);
	if (status != XST_SUCCESS) {
		return XST_FAILURE;
	}

	// Check that hardware is correctly built
	XCanPs_SelfTest(&CAN_PS[ID]);
	if (status != XST_SUCCESS) {
		return XST_FAILURE;
	}

	// Enter configuration mode
	XCanPs_EnterMode(&CAN_PS[ID], XCANPS_MODE_CONFIG);
	while(XCanPs_GetMode(&CAN_PS[ID]) != XCANPS_MODE_CONFIG);

	// Set Baud Rate Prescaler and Bit Timing
	XCanPs_SetBaudRatePrescaler(&CAN_PS[ID], TEST_BRPR_BAUD_PRESCALER);
	if (status != XST_SUCCESS) {
		return XST_FAILURE;
	}
	XCanPs_SetBitTiming(&CAN_PS[ID], TEST_BTR_SYNCJUMPWIDTH, TEST_BTR_SECOND_TIMESEGMENT, TEST_BTR_FIRST_TIMESEGMENT);
	if (status != XST_SUCCESS) {
		return XST_FAILURE;
	}

	return status;
}

// -------------------------------------------------
int can_send(u16 ID, u32 *frameptr) {
	return XCanPs_Send(&CAN_PS[ID], frameptr);
}

// -------------------------------------------------
int can_receive(u16 ID, u32 *frameptr) {
	return XCanPs_Recv(&CAN_PS[ID], frameptr);
}

// -------------------------------------------------
void can_loopback_mode(u16 ID) {
	XCanPs_EnterMode(&CAN_PS[ID], XCANPS_MODE_LOOPBACK);
	while(XCanPs_GetMode(&CAN_PS[ID]) != XCANPS_MODE_LOOPBACK);
}

// -------------------------------------------------
void can_normal_mode(u16 ID) {
	XCanPs_EnterMode(&CAN_PS[ID], XCANPS_MODE_NORMAL);
	while(XCanPs_GetMode(&CAN_PS[ID]) != XCANPS_MODE_NORMAL);
}

// -------------------------------------------------
int can_txready(u16 ID) {
	return XCanPs_IsTxFifoFull(&CAN_PS[ID]);
}

// -------------------------------------------------
int can_rxready(u16 ID) {
	return XCanPs_IsRxEmpty(&CAN_PS[ID]);
}
